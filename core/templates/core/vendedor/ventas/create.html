{% extends 'core/base_dashboard.html' %}
{% block title %}Registrar Venta{% endblock %}
{% block content %}

<div class="max-w-4xl mx-auto mt-8">
  <h2 class="text-2xl font-bold text-green-400 mb-4">‚ûï Registrar Venta</h2>

  <form method="post">
    {% csrf_token %}

    <!-- Cliente -->
    <div class="mb-4">
      <label class="block text-green-400 mb-2 font-semibold">üßç Cliente</label>
      <input type="text" id="cliente-autocomplete" placeholder="Buscar cliente..."
             class="w-full p-2 bg-gray-900 border border-green-500 rounded text-white" autocomplete="off">
      <input type="hidden" name="cliente" id="cliente-id">
      <div id="cliente-sugerencias"
           class="bg-zinc-800 border border-zinc-600 rounded mt-1 text-white hidden z-40 absolute w-full"></div>
    </div>

    <!-- Tipo de Pago -->
    <div class="mb-4">
      <label class="block text-green-400 mb-2 font-semibold">üí≥ Tipo de Pago</label>
      <select name="tipo_pago" required
              class="w-full p-2 bg-gray-900 border border-green-500 rounded text-white">
        <option value="" disabled selected>Seleccione una opci√≥n...</option>
        <option value="contado">Contado</option>
        <option value="credito">Cr√©dito</option>
        <option value="transferencia">Transferencia</option>
        <option value="garantia">Garant√≠a</option>
      </select>
    </div>

    <!-- Productos -->
    <div id="productos-container" class="space-y-4 mb-4"></div>
    <button type="button" onclick="agregarProducto()"
            class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded">
      ‚ûï Agregar Producto
    </button>

    <!-- Total -->
    <div class="mt-4">
      <p class="text-green-300 font-bold text-lg">üíµ Total: $<span id="total">0.00</span></p>
    </div>

    <!-- Campos ocultos -->
    <input type="hidden" name="productos_data" id="productos-data">

    <!-- Bot√≥n de env√≠o -->
    <button type="submit"
            class="mt-6 bg-green-600 hover:bg-green-700 text-black font-bold px-4 py-2 rounded w-full">
      üíæ Registrar Venta
    </button>
  </form>
</div>

<script>
let index = 0;

function agregarProducto() {
  const container = document.getElementById("productos-container");
  const productoDiv = document.createElement("div");
  productoDiv.className = "producto bg-zinc-800 p-4 rounded shadow-md";

  productoDiv.innerHTML = `
    <div class="relative mb-2">
      <input type="text" placeholder="Buscar producto..."
             class="producto-autocomplete w-full p-2 bg-gray-900 border border-green-500 rounded text-white"
             data-index="${index}" autocomplete="off">
      <input type="hidden" class="producto-id" data-index="${index}">
      <div class="sugerencias-producto absolute w-full bg-zinc-800 border border-zinc-600 rounded mt-1 hidden z-50 text-white"></div>
    </div>
    <div class="flex justify-between items-center gap-2">
      <div class="text-sm text-green-300 font-mono hidden stock-label" data-index="${index}"></div>
      <input type="number" min="1" value="1"
           class="cantidad-input w-1/2 p-2 bg-gray-900 border border-green-500 rounded text-white"
           data-index="${index}" placeholder="Cantidad" onchange="validarCantidad(${index})">
    </div>
    <div class="mt-2">
      <span class="text-green-300 font-semibold">Subtotal: $<span class="subtotal" data-index="${index}">0.00</span></span>
    </div>
  `;
  container.appendChild(productoDiv);
  index++;
}

// Autocompletado cliente
document.getElementById("cliente-autocomplete").addEventListener("input", async function () {
  const q = this.value;
  const lista = document.getElementById("cliente-sugerencias");
  if (q.length < 2) return lista.classList.add("hidden");
  const res = await fetch(`/ajax/buscar-clientes/?q=${q}`);
  const data = await res.json();
  lista.innerHTML = "";
  data.forEach(cliente => {
    const div = document.createElement("div");
    div.textContent = `${cliente.nombre} (${cliente.cedula})`;
    div.classList.add("p-2", "hover:bg-zinc-700", "cursor-pointer");
    div.onclick = () => {
      document.getElementById("cliente-autocomplete").value = `${cliente.nombre} (${cliente.cedula})`;
      document.getElementById("cliente-id").value = cliente.id;
      lista.classList.add("hidden");
    };
    lista.appendChild(div);
  });
  lista.classList.remove("hidden");
});

// Autocompletado producto
document.addEventListener("input", async function (e) {
  if (!e.target.classList.contains("producto-autocomplete")) return;
  const q = e.target.value;
  const index = e.target.dataset.index;
  const lista = e.target.nextElementSibling.nextElementSibling;
  if (q.length < 2) return lista.classList.add("hidden");

  const res = await fetch(`/ajax/buscar-productos/?q=${q}`);
  const data = await res.json();
  lista.innerHTML = "";
  data.forEach(prod => {
    const div = document.createElement("div");
    div.textContent = `${prod.reference} - ${prod.description}`;
    div.classList.add("p-2", "hover:bg-zinc-700", "cursor-pointer");
    div.onclick = () => {
      // Evitar duplicados visualmente
      const yaSeleccionado = Array.from(document.querySelectorAll(".producto-id"))
        .some(el => el.value == prod.id);
      if (yaSeleccionado) {
        alert("‚ö†Ô∏è Este producto ya fue agregado.");
        lista.classList.add("hidden");
        return;
      }

      e.target.value = `${prod.reference} - ${prod.description}`;
      document.querySelector(`.producto-id[data-index='${index}']`).value = prod.id;
      e.target.setAttribute("data-precio", prod.sale_price);
      e.target.setAttribute("data-stock", prod.stock);
      const label = document.querySelector(`.stock-label[data-index='${index}']`);
      label.innerText = `üì¶ Stock disponible: ${prod.stock}`;
      label.classList.remove("hidden");
      validarCantidad(index);
      lista.classList.add("hidden");
    };
    lista.appendChild(div);
  });
  lista.classList.remove("hidden");
});

// Validaci√≥n por stock
function validarCantidad(index) {
  const cantidadInput = document.querySelector(`.cantidad-input[data-index='${index}']`);
  const autocomplete = document.querySelector(`.producto-autocomplete[data-index='${index}']`);
  const stock = parseInt(autocomplete.getAttribute("data-stock")) || 0;
  const cantidad = parseInt(cantidadInput.value) || 0;

  if (cantidad > stock) {
    alert("‚ùå La cantidad excede el stock disponible.");
    cantidadInput.value = stock;
  }

  actualizarTotal();
}

// Total din√°mico
function actualizarTotal() {
  let total = 0;
  let productos = [];
  let usados = new Set();

  document.querySelectorAll(".producto-id").forEach((input, i) => {
    const productoId = input.value;
    const cantidad = parseInt(document.querySelectorAll(".cantidad-input")[i].value);
    const precio = parseFloat(document.querySelectorAll(".producto-autocomplete")[i].getAttribute("data-precio") || 0);
    const subtotalSpan = document.querySelectorAll(".subtotal")[i];

    if (productoId && cantidad > 0) {
      if (usados.has(productoId)) {
        subtotalSpan.textContent = "0.00";
        document.querySelectorAll(".cantidad-input")[i].value = 0;
        return;
      }

      usados.add(productoId);
      const subtotal = cantidad * precio;
      subtotalSpan.textContent = subtotal.toFixed(2);
      total += subtotal;
      productos.push({ producto_id: productoId, cantidad });
    } else {
      subtotalSpan.textContent = "0.00";
    }
  });

  document.getElementById("total").textContent = total.toFixed(2);
  document.getElementById("productos-data").value = JSON.stringify(productos);
}
</script>

{% endblock %}
