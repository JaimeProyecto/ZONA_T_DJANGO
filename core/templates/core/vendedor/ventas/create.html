{% extends 'core/base_dashboard.html' %}
{% block title %}Registrar Venta{% endblock %}
{% block content %}

<div class="max-w-4xl mx-auto mt-8">
  <h2 class="text-2xl font-bold text-green-400 mb-4">➕ Registrar Venta</h2>

  <form method="post">
    {% csrf_token %}

    <!-- Cliente -->
    <div class="mb-4 relative">
      <label class="block text-green-400 mb-2 font-semibold">🧍 Cliente</label>
      <input type="text" id="cliente-autocomplete" placeholder="Buscar cliente..."
             class="w-full p-2 bg-gray-900 border border-green-500 rounded text-white"
             autocomplete="off">
      <input type="hidden" name="cliente" id="cliente-id">
      <div id="cliente-sugerencias"
           class="bg-zinc-800 border border-zinc-600 rounded mt-1 text-white hidden absolute w-full z-50"></div>
    </div>

    <!-- Tipo de Pago -->
    <div class="mb-4">
      <label class="block text-green-400 mb-2 font-semibold">💳 Tipo de Pago</label>
      <select name="tipo_pago" required
              class="w-full p-2 bg-gray-900 border border-green-500 rounded text-white">
        <option value="" disabled selected>Seleccione una opción...</option>
        <option value="contado">Contado</option>
        <option value="credito">Crédito</option>
        <option value="transferencia">Transferencia</option>
        <option value="garantia">Garantía</option>
      </select>
    </div>

    <!-- Productos -->
    <div id="productos-container" class="space-y-4 mb-4"></div>
    <button type="button" onclick="agregarProducto()"
            class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded">
      ➕ Agregar Producto
    </button>

    <!-- Total -->
    <div class="mt-4">
      <p class="text-green-300 font-bold text-lg">
        💵 Total: $<span id="total">0</span>
      </p>
    </div>

    <!-- JSON de productos -->
    <input type="hidden" name="productos_data" id="productos-data">

    <!-- Botón de envío -->
    <button type="submit"
            class="mt-6 bg-green-600 hover:bg-green-700 text-black font-bold px-4 py-2 rounded w-full">
      💾 Registrar Venta
    </button>
  </form>
</div>

<script>
// Formatea con separador de miles
function formatoMiles(n) {
  return new Intl.NumberFormat('es-CO', {minimumFractionDigits:0}).format(n);
}

let index = 0;
function agregarProducto() {
  const container = document.getElementById("productos-container");
  const div = document.createElement("div");
  div.className = "producto bg-zinc-800 p-4 rounded shadow-md";
  div.setAttribute("data-index", index);
  div.innerHTML = `
    <div class="relative mb-2">
      <input type="text"
             class="producto-autocomplete w-full p-2 bg-gray-900 border border-green-500 rounded text-white"
             placeholder="Buscar producto..." data-index="${index}" autocomplete="off">
      <input type="hidden" class="producto-id" data-index="${index}">
      <div class="sugerencias-producto absolute w-full bg-zinc-800 border border-zinc-600 rounded mt-1 hidden z-50 text-white"></div>
    </div>
    <div class="flex items-center gap-2">
      <input type="number" min="1" value="1"
             class="cantidad-input w-1/3 p-2 bg-gray-900 border border-green-500 rounded text-white"
             data-index="${index}" placeholder="Cant." />
      <input type="number" min="0" step="1000"
             class="precio-input w-2/3 p-2 bg-gray-900 border border-green-500 rounded text-white"
             data-index="${index}" placeholder="Precio (mil)" />
    </div>
    <div class="mt-2">
      <span class="text-green-300 font-semibold">
        Subtotal: $<span class="subtotal" data-index="${index}">0</span>
      </span>
    </div>
    <button type="button" class="remover-linea mt-2 text-red-400 hover:underline">Eliminar</button>
  `;
  container.appendChild(div);
  index++;
}

// Recalcula subtotales y total general
function recalcular() {
  let total = 0;
  const productos = [];

  document.querySelectorAll(".producto").forEach(div => {
    const i = div.getAttribute("data-index");
    const pid = div.querySelector(`.producto-id[data-index="${i}"]`).value;
    const cant = parseInt(div.querySelector(`.cantidad-input[data-index="${i}"]`).value) || 0;
    const precio = parseFloat(div.querySelector(`.precio-input[data-index="${i}"]`).value) || 0;
    const sub = cant * precio;
    div.querySelector(`.subtotal[data-index="${i}"]`).textContent = formatoMiles(sub);
    if (pid && cant>0 && precio>0) {
      total += sub;
      productos.push({producto_id: pid, cantidad: cant, precio_unitario: precio});
    }
  });

  document.getElementById("total").textContent = formatoMiles(total);
  document.getElementById("productos-data").value = JSON.stringify(productos);
}

// Delegación de eventos
document.addEventListener("input", e => {
  if (e.target.matches(".cantidad-input") || e.target.matches(".precio-input")) {
    recalcular();
  }
});

// Eliminar línea
document.getElementById("productos-container").addEventListener("click", e => {
  if (e.target.matches(".remover-linea")) {
    e.target.closest(".producto").remove();
    recalcular();
  }
});

// Autocomplete cliente y producto (igual que antes, omitido por brevedad)
// … tu código AJAX para buscar clientes y productos …

</script>
{% endblock %}
